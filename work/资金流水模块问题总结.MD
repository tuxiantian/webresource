05.28日未知的原因导致阿里的RocketMq消息出现了重复的消费。因为消息的重复消费出现了高并发的问题，导致分公司的资金流水出现错乱。

针对以上问题，做出了2点调整：

- 在生成收益时，先查询数据库判断当前业务流水是否已经产生了收益，此举解决了消息的重复消费产生的问题。

  ![2018-06-08_115347](D:/webresource/images/work/资金流水/2018-06-08_115347.png)

  持续观察数据是否有重复生成的收益

  ```sql
  SELECT t.`SN` ,t.REFID,t.`Amount`, COUNT(*) cc FROM `t_custaccount_income` t where t.custid =1 and createtime>'2018-06-06' 
  and t.`BussType` not IN (16,17)  GROUP BY t.`BussType` ,t.`REFID` HAVING cc>1
  ```

  生成收益->生成流水->变更账户

  在进行上述操作流程时，先检查这笔业务的收益是否已经生成，若生成直接返回不再进行后续处理。

- 优化了资金流水模块分布式锁的使用方式，这解决了高并发的问题。

  这是出现问题的版本，及高并发问题的举例阐述。

  ![2018-06-08_105445](D:/webresource/images/work/资金流水/2018-06-08_105445.png)

  下面是并发问题的解决方案。主要是通过优化了资金流水模块分布式锁的使用方式解决的。

  ![2018-06-08_104518](D:/webresource/images/work/资金流水/2018-06-08_104518.png)

  观察是否有并发数据产生的查询语句

  ```sql
  SELECT * FROM `t_custaccountseq` a 
  where  (a.`PreAmount` in(select `PreAmount` from `t_custaccountseq` where sn=a.sn+1) or a.`PreAmount` in(select `PreAmount` from `t_custaccountseq` where sn=a.sn-1) );
  ```
  ## 申请提现流程

  ### 旧版申请提现流程

  **申请提现** 
  	产生申请记录，分公司账户的余额、可提现金额、总提现变化(校验分公司可提现金额是否够)
  **通过提现申请**	
  	产生资金流水
  	申请状态修改
  **拒绝提现申请**
  	分公司账户的余额、可提现金额、总提现发生变化
  	申请状态修改

  **旧版的申请提现流程存在的问题**
  在分公司发出提现申请后，总部还没有审核，在此期间产生了资金流水。总部审核通过后，产生了申请提现的资金流水。这时看到的资金变动前金额，和申请时候的分公司账户余额已经不同了。在看资金流水的时候会感到困惑。

  ![2018-06-08_150257](D:/webresource/images/work/资金流水/2018-06-08_150257.png)

  ### **新版申请提现流程**

  **申请提现** 
  	产生申请记录，分公司账户的余额、可提现金额、总提现不在变化
  **通过提现申请**
  	分公司账户的余额、可提现金额、总提现发生变化(校验分公司可提现金额是否够)
  	产生资金流水
  	申请状态修改
  **拒绝提现申请**
  	申请状态修改

  从流程上说，新版的申请提现流程更简单。在拒绝的时候不涉及分公司资金账户的变动。

  ## 有惊无险的发布

  从旧版的申请提现到新版的申请提现，我是直接修改原来的接口方法，所以在升级的时候应该保证没有提现申请。但是我当时就是没有想到这个，就直接发布了。更糟糕的是这次发布居然没有写发布日志。

  ![2018-06-08_141222](D:/webresource/images/work/资金流水/2018-06-08_141222.png)

  ![2018-06-08_141353](D:/webresource/images/work/资金流水/2018-06-08_141353.png)

  ![2018-06-08_141453](D:/webresource/images/work/资金流水/2018-06-08_141453.png)

  从第一张图看到2018-06-06 08:47:43 总部审核通过了一笔诸城分公司的提现申请。如果这比审核发生在我发布新版的提现申请之后，那么就会出问题了。因为新版的提现申请审核通过后会扣分公司的账户余额，而旧版的提现申请已经提前扣除分公司的申请提现金额了。想到我没有做发布记录，所以我不确定我的发布是否在这个审核操作之后。我只能去看代码的提交记录，从代码的提交记录看到`200ba83 tuxiantian on 2018-06-06 at 11:26 `，确定我的发布是在总部的审核操作完成后进行的，我真是松了口气。

  2018-06-06 17:21:53 还发生了一笔提现申请，这笔提现申请还没有处理。如果这笔提现申请发生在我的代码发布之前就会有问题。可是我怎么确定我的代码的发布时间呢？我突然想到每次发布的时候，会备份上次使用的jar，备份的jar中含有当时的时间。如第三张图所示，我分别在`2018-06-06 14:01:24`和`2018-06-06 15:02:34`进行了发布操作。由此可以确定那笔提现申请发生在我的代码发布之后，我心里的石头终于落地了。

  **由此看见做发布记录是多么的重要，否则根本无法确定可能出现的问题是否发生。另外，我们在修改代码时一定要考虑对之前使用该功能的用户的影响。**